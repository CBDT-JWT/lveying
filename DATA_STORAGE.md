# 数据持久化存储说明

## 📦 存储方式

系统使用 **JSON文件** 作为持久化存储方案，所有数据保存在 `data/store.json` 文件中。

## ✨ 主要优势

- ✅ **自动持久化**：所有操作自动保存到文件
- ✅ **重启不丢失**：服务器重启后数据完整保留
- ✅ **易于备份**：直接复制JSON文件即可备份
- ✅ **易于迁移**：可以直接复制到其他服务器
- ✅ **易于调试**：可以直接查看和编辑JSON文件

## 📂 数据结构

`data/store.json` 文件包含以下数据：

```json
{
  "programs": [
    {
      "id": "1",
      "title": "开场舞",
      "performer": "舞蹈团",
      "order": 1,
      "completed": false
    }
  ],
  "danmakus": [
    {
      "id": "1234567890",
      "content": "祝晚会圆满成功！",
      "timestamp": 1234567890000
    }
  ],
  "lotteryConfig": {
    "minNumber": 1,
    "maxNumber": 100,
    "count": 5
  },
  "lotteryResult": {
    "numbers": [23, 45, 67, 12, 89],
    "timestamp": 1234567890000
  }
}
```

## 🔄 自动保存机制

以下操作会自动保存数据：

### 节目管理
- ✅ 更新节目单
- ✅ 修改节目状态（完成/未完成）

### 弹幕管理
- ✅ 发送新弹幕
- ✅ 清空弹幕列表

### 抽奖管理
- ✅ 更新抽奖配置
- ✅ 保存抽奖结果
- ✅ 清空抽奖结果

## 📋 数据文件位置

```
lueying/
└── data/
    ├── store.json          # 主数据文件（自动创建）
    └── .gitkeep           # Git占位文件
```

**注意**：`data/` 目录已加入 `.gitignore`，不会提交到版本控制系统。

## 🛠️ 手动操作

### 备份数据

**方法1：直接复制文件**
```bash
cp data/store.json data/store.backup.json
```

**方法2：使用API备份**
```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:3000/api/admin/data > backup.json
```

### 恢复数据

直接替换 `data/store.json` 文件：
```bash
cp data/store.backup.json data/store.json
```

然后重启服务器。

### 重置数据

**方法1：删除文件**
```bash
rm data/store.json
```
服务器会自动创建新的默认数据文件。

**方法2：使用API重置**
```bash
curl -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"action":"reset"}' \
  http://localhost:3000/api/admin/data
```

### 手动编辑数据

1. 停止服务器
2. 编辑 `data/store.json` 文件
3. 确保JSON格式正确
4. 重新启动服务器

## 🔍 调试信息

服务器启动和数据操作时会在控制台输出日志：

- ✅ `从文件加载数据成功` - 成功加载现有数据
- 📝 `使用默认数据并创建新文件` - 创建新数据文件
- 💾 `数据已保存到文件` - 数据保存成功
- ❌ `加载/保存数据文件失败` - 发生错误

## ⚠️ 注意事项

### 并发写入
- JSON文件存储不支持高并发写入
- 适合小型晚会使用（几百人同时在线）
- 如需支持更大规模，建议升级到数据库

### 文件权限
- 确保 `data/` 目录有写入权限
- 如果遇到权限问题：
  ```bash
  chmod 755 data/
  chmod 644 data/store.json
  ```

### 数据安全
- 定期备份 `data/store.json` 文件
- 重要数据建议使用版本控制或云存储备份
- 不要将数据文件提交到公开的Git仓库

## 🚀 升级到数据库

如果需要支持更大规模或更复杂的场景，可以考虑：

### SQLite
- 轻量级，单文件数据库
- 适合中小型应用
- 安装简单，不需要服务器

### PostgreSQL/MySQL
- 适合生产环境
- 支持高并发
- 需要独立的数据库服务器

### MongoDB
- NoSQL方案
- 文档型数据库
- 与JSON结构天然匹配

## 📊 数据统计

当前存储的数据量估算：

- **节目单**：约5-20条记录
- **弹幕**：可能上千条（建议定期清理）
- **抽奖记录**：每次抽奖1条记录
- **总文件大小**：通常小于100KB

## 🎯 最佳实践

1. **晚会前**：备份当前数据文件
2. **晚会中**：避免手动编辑数据文件
3. **晚会后**：导出数据文件作为存档
4. **定期清理**：清除过时的弹幕数据
5. **测试环境**：使用独立的数据文件

## 💡 常见问题

### Q: 数据文件在哪里？
A: `项目根目录/data/store.json`

### Q: 可以手动编辑吗？
A: 可以，但需要停止服务器，编辑后重启

### Q: 如何迁移到新服务器？
A: 复制整个 `data/` 文件夹即可

### Q: 数据会丢失吗？
A: 不会，每次操作都会立即保存到文件

### Q: 如何查看数据？
A: 直接打开 `data/store.json` 文件查看

---

**提示**：这是一个简单但有效的持久化方案，适合大多数晚会场景使用。
